---
- name: Fetch Incident and Update Incident fields data from ServiceNow
  hosts: localhost
  gather_facts: no
  vars:
    short_Descriptions: "{{ short_Descriptions }}"
    mysql_query: "SELECT * FROM incidentdata.incidentConfigDetails;;"
  tasks:
    - block:
        - name: include  playbook to fetch Incident
          include: includeDbconnectTofetchINC.yml 
          register: short_Descriptions
        - name: print var
          debug:
            var: short_Descriptions

        - name: Call the MySQL Query Playbook
          include_tasks: mysql_query_playbook.yml
          vars:
            query: "{{ mysql_query }}"

        - name: Display the result from the MySQL Query Playbook
          debug:
           var: query_result

        - name: Extract ci_name using json_query 
          set_fact: 
           extracted_ci_name: "{{ query_result.stdout_lines[1:] | map('regex_replace', '^\\|\\s*(.*?)\\s*\\|\\s*(.*?)\\s*\\|$', '\\1,\\2') | list }}"  
        - name: ci_name value 
          debug:
           var: extracted_ci_name
     
        - name: Separating ciname
          set_fact:
            ciname_value: "{{ short_Descriptions  | regex_search('query_result.ci_name is (' + query_result.ci_name + ')', '\\1') }}"
            

      
      rescue:
        - name: Log Output For Failure
          debug:
            msg: "Log : FAILED : Task {{ ansible_failed_task.name }} Failed and the ERROR:
              {{ ansible_failed_result }}"
          failed_when: true

